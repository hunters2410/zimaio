import{e as L,u as O,r as n,g as z,s as i,j as e,c as y,o as f,d as H,S as _,x as S,l as W}from"./index-T9wcIP7k.js";import{A as C}from"./arrow-left-CeWPuxjJ.js";import{C as B}from"./circle-CdTX2oci.js";function Z(){const{user:t}=L(),p=O(),[m,u]=n.useState([]),[r,h]=n.useState(null),[b,w]=n.useState([]),[o,j]=n.useState(""),[E,A]=n.useState(!0),[M,k]=n.useState(!1),v=n.useRef(null),[q]=z();n.useEffect(()=>{t!=null&&t.id?(N(),V()):p("/login")},[t==null?void 0:t.id]),n.useEffect(()=>{r&&($(r.id),P(r.id))},[r]),n.useEffect(()=>{R()},[b]);const R=()=>{var a;(a=v.current)==null||a.scrollIntoView({behavior:"smooth"})},V=()=>{const a=i.channel("customer_chat_changes").on("postgres_changes",{event:"*",schema:"public",table:"chat_messages"},s=>{r&&s.new&&s.new.conversation_id===r.id&&w(l=>l.find(x=>x.id===s.new.id)?l:[...l,s.new]),N()}).subscribe();return()=>{i.removeChannel(a)}},N=async()=>{try{const{data:a,error:s}=await i.from("chat_conversations").select("*").contains("participant_ids",[t==null?void 0:t.id]).order("last_message_at",{ascending:!1});if(s)throw s;const l=await Promise.all((a||[]).map(async d=>{const g=d.participant_ids.find(D=>D!==(t==null?void 0:t.id)),{data:c}=await i.from("vendor_profiles").select("shop_name, shop_logo_url").eq("user_id",g).single(),{count:T}=await i.from("chat_messages").select("*",{count:"exact",head:!0}).eq("conversation_id",d.id).eq("is_read",!1).neq("sender_id",t==null?void 0:t.id);return{...d,vendor_name:(c==null?void 0:c.shop_name)||"Premium Vendor",vendor_logo:c==null?void 0:c.shop_logo_url,unread_count:T||0}}));u(l);const x=q.get("cid");if(x){const d=l.find(g=>g.id===x);d&&h(d)}}catch(a){console.error("Error fetching conversations:",a)}finally{A(!1)}},$=async a=>{try{const{data:s,error:l}=await i.from("chat_messages").select("*").eq("conversation_id",a).order("created_at",{ascending:!0});if(l)throw l;w(s||[])}catch(s){console.error("Error fetching messages:",s)}},P=async a=>{await i.from("chat_messages").update({is_read:!0}).eq("conversation_id",a).neq("sender_id",t==null?void 0:t.id),u(s=>s.map(l=>l.id===a?{...l,unread_count:0}:l))},I=async a=>{if(a.preventDefault(),!o.trim()||!r||!(t!=null&&t.id))return;k(!0);const s=o.trim();j("");try{const{error:l}=await i.from("chat_messages").insert({conversation_id:r.id,sender_id:t.id,message:s});if(l)throw l;await i.from("chat_conversations").update({last_message:s,last_message_at:new Date().toISOString()}).eq("id",r.id)}catch(l){console.error("Error sending message:",l)}finally{k(!1)}};return E?e.jsx("div",{className:"min-h-screen flex items-center justify-center bg-gray-50 dark:bg-slate-900",children:e.jsx("div",{className:"w-12 h-12 border-4 border-emerald-500/20 border-t-emerald-500 rounded-full animate-spin"})}):e.jsxs("div",{className:"min-h-screen bg-gray-50 dark:bg-slate-950 flex flex-col transition-colors duration-500",children:[e.jsx("div",{className:"bg-white dark:bg-slate-900 border-b border-gray-100 dark:border-slate-800 flex-none sticky top-16 md:top-0 z-40",children:e.jsx("div",{className:"container mx-auto px-4 py-6 md:py-10",children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{className:"flex items-center gap-6",children:[e.jsx("button",{onClick:()=>p(-1),className:"p-3 bg-gray-50 dark:bg-slate-800 rounded-2xl hover:bg-emerald-50 dark:hover:bg-emerald-900/20 transition-all active:scale-95 group",children:e.jsx(C,{className:"w-6 h-6 text-gray-400 group-hover:text-emerald-500"})}),e.jsxs("div",{children:[e.jsx("h1",{className:"text-2xl md:text-4xl font-black text-gray-900 dark:text-white uppercase tracking-tighter mb-1",children:"Support Concierge"}),e.jsxs("p",{className:"text-[10px] text-emerald-600 font-black uppercase tracking-[0.3em] flex items-center gap-2",children:[e.jsx(y,{className:"w-3.5 h-3.5"})," Verified Vendor Communications"]})]})]}),e.jsxs("div",{className:"hidden lg:flex items-center gap-4",children:[e.jsxs("div",{className:"text-right",children:[e.jsx("p",{className:"text-sm font-black text-gray-900 dark:text-white uppercase tracking-tight",children:"Active Conversations"}),e.jsxs("p",{className:"text-[10px] text-gray-400 font-bold uppercase tracking-widest",children:[m.length," total channels"]})]}),e.jsx("div",{className:"w-12 h-12 bg-emerald-50 dark:bg-emerald-900/20 rounded-2xl flex items-center justify-center",children:e.jsx(f,{className:"w-6 h-6 text-emerald-600"})})]})]})})}),e.jsx("div",{className:"flex-1 container mx-auto px-0 md:px-4 py-0 md:py-8 flex flex-col overflow-hidden",children:e.jsxs("div",{className:"bg-white dark:bg-slate-900 md:rounded-[3rem] border-gray-100 dark:border-slate-800 shadow-2xl overflow-hidden flex flex-col md:flex-row flex-1 h-[calc(100vh-140px)] md:h-[750px] border",children:[e.jsxs("div",{className:`w-full md:w-[400px] border-r border-gray-50 dark:border-slate-800 flex flex-col bg-white dark:bg-slate-900 ${r?"hidden md:flex":"flex"}`,children:[e.jsx("div",{className:"p-8 border-b border-gray-50 dark:border-slate-800",children:e.jsxs("div",{className:"relative group",children:[e.jsx(H,{className:"absolute left-4 top-1/2 -translate-y-1/2 h-4 w-4 text-gray-400 dark:text-slate-600"}),e.jsx("input",{type:"text",placeholder:"SEARCH VENDORS...",className:"w-full pl-12 pr-4 py-4 bg-gray-50 dark:bg-slate-800/50 border-none rounded-2xl text-[10px] font-black uppercase tracking-widest outline-none focus:ring-4 focus:ring-emerald-500/5 transition-all text-gray-900 dark:text-white"})]})}),e.jsx("div",{className:"flex-1 overflow-y-auto custom-scrollbar",children:m.length===0?e.jsxs("div",{className:"p-16 text-center",children:[e.jsx("div",{className:"w-20 h-20 bg-gray-50 dark:bg-slate-800 rounded-[2rem] flex items-center justify-center mx-auto mb-6",children:e.jsx(f,{className:"h-10 w-10 text-gray-200 dark:text-slate-700"})}),e.jsx("p",{className:"text-[10px] font-black text-gray-400 uppercase tracking-widest leading-loose",children:"No active concierge channels"})]}):e.jsx("div",{className:"divide-y divide-gray-50 dark:divide-slate-800/50",children:m.map(a=>e.jsxs("button",{onClick:()=>h(a),className:`w-full p-8 flex items-center gap-6 hover:bg-emerald-50/30 dark:hover:bg-emerald-900/10 transition-all text-left group ${(r==null?void 0:r.id)===a.id?"bg-emerald-50/50 dark:bg-emerald-900/20 border-r-4 border-emerald-500":""}`,children:[e.jsxs("div",{className:"relative shrink-0",children:[e.jsx("div",{className:"w-16 h-16 bg-gray-100 dark:bg-slate-800 rounded-[1.5rem] flex items-center justify-center overflow-hidden shadow-inner group-hover:scale-105 transition-transform duration-500",children:a.vendor_logo?e.jsx("img",{src:a.vendor_logo,className:"w-full h-full object-cover",alt:""}):e.jsx(_,{className:"h-8 w-8 text-gray-400 dark:text-slate-600"})}),e.jsx("div",{className:"absolute -bottom-1 -right-1 w-5 h-5 bg-green-500 border-4 border-white dark:border-slate-900 rounded-full"})]}),e.jsxs("div",{className:"flex-1 min-w-0",children:[e.jsxs("div",{className:"flex items-center justify-between mb-2",children:[e.jsx("h4",{className:"text-sm font-black text-gray-900 dark:text-white uppercase truncate tracking-tight",children:a.vendor_name}),a.unread_count!==void 0&&a.unread_count>0&&e.jsx("span",{className:"bg-emerald-600 text-white text-[9px] px-2 py-0.5 font-black rounded-lg shadow-lg animate-bounce",children:a.unread_count})]}),e.jsx("p",{className:"text-[10px] font-bold text-gray-500 dark:text-slate-400 truncate uppercase tracking-widest opacity-60",children:a.last_message||"Start chatting..."}),e.jsx("p",{className:"text-[8px] font-black text-gray-300 dark:text-slate-600 uppercase tracking-tighter mt-1",children:new Date(a.last_message_at).toLocaleDateString()})]})]},a.id))})})]}),e.jsx("div",{className:`flex-1 flex flex-col bg-gray-50/50 dark:bg-slate-900/50 w-full ${r?"flex":"hidden md:flex"}`,children:r?e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"p-6 md:p-8 bg-white dark:bg-slate-900 border-b border-gray-100 dark:border-slate-800 flex items-center justify-between shadow-sm z-10",children:[e.jsxs("div",{className:"flex items-center gap-6 overflow-hidden",children:[e.jsx("button",{onClick:()=>h(null),className:"md:hidden p-3 bg-gray-50 dark:bg-slate-800 rounded-2xl text-gray-500",children:e.jsx(C,{className:"w-5 h-5"})}),e.jsx("div",{className:"w-14 h-14 bg-gray-100 dark:bg-slate-800 rounded-2xl flex items-center justify-center overflow-hidden shrink-0 shadow-inner",children:r.vendor_logo?e.jsx("img",{src:r.vendor_logo,className:"w-full h-full object-cover",alt:""}):e.jsx(_,{className:"h-7 w-7 text-gray-400 dark:text-slate-600"})}),e.jsxs("div",{className:"min-w-0",children:[e.jsx("h4",{className:"text-xl font-black text-gray-900 dark:text-white uppercase tracking-tighter truncate",children:r.vendor_name}),e.jsxs("p",{className:"text-[9px] font-black text-emerald-600 uppercase tracking-[0.2em] flex items-center gap-2 mt-1",children:[e.jsx(B,{className:"w-2 h-2 fill-current animate-pulse"})," Established Connection"]})]})]}),e.jsxs("div",{className:"hidden lg:flex items-center gap-4",children:[e.jsx("button",{className:"text-[9px] font-black uppercase tracking-widest text-gray-400 hover:text-emerald-600 transition-colors",children:"Order History"}),e.jsx("div",{className:"w-px h-4 bg-gray-100 dark:bg-slate-800"}),e.jsx("button",{className:"text-[9px] font-black uppercase tracking-widest text-gray-400 hover:text-emerald-600 transition-colors",children:"Vendor Profile"})]})]}),e.jsxs("div",{className:"flex-1 overflow-y-auto p-6 md:p-12 space-y-8 custom-scrollbar",children:[b.map(a=>{const s=a.sender_id===(t==null?void 0:t.id);return e.jsx("div",{className:`flex ${s?"justify-end":"justify-start"}`,children:e.jsxs("div",{className:`max-w-[90%] md:max-w-[75%] space-y-2 flex flex-col ${s?"items-end":"items-start"}`,children:[e.jsx("div",{className:`p-6 md:p-8 rounded-[2rem] text-sm md:text-base leading-relaxed ${s?"bg-emerald-600 text-white shadow-2xl shadow-emerald-200 dark:shadow-emerald-900/10 rounded-tr-none font-bold":"bg-white dark:bg-slate-800 text-gray-700 dark:text-gray-200 border border-gray-100 dark:border-slate-700 shadow-xl rounded-tl-none font-medium"}`,children:a.message}),e.jsxs("div",{className:`flex items-center gap-2 px-2 ${s?"flex-row-reverse":""}`,children:[e.jsx("span",{className:`text-[9px] font-black uppercase tracking-widest ${s?"text-emerald-400":"text-gray-400 dark:text-slate-500"}`,children:new Date(a.created_at).toLocaleTimeString([],{hour:"2-digit",minute:"2-digit"})}),s&&e.jsx(S,{className:"w-3.5 h-3.5 text-emerald-500"})]})]})},a.id)}),e.jsx("div",{ref:v})]}),e.jsxs("div",{className:"p-6 md:p-10 bg-white dark:bg-slate-900 border-t border-gray-100 dark:border-slate-800 z-10",children:[e.jsxs("form",{onSubmit:I,className:"flex items-center gap-4 max-w-5xl mx-auto",children:[e.jsx("div",{className:"flex-1 relative group",children:e.jsx("input",{type:"text",value:o,onChange:a=>j(a.target.value),placeholder:"WRITE A DIRECT MESSAGE...",className:"w-full bg-gray-50 dark:bg-slate-800 border-none rounded-[1.5rem] px-8 py-5 text-sm font-black uppercase tracking-widest outline-none focus:ring-4 focus:ring-emerald-500/5 transition-all text-gray-900 dark:text-white placeholder:text-gray-300 dark:placeholder:text-slate-600"})}),e.jsx("button",{type:"submit",disabled:M||!o.trim(),className:"p-5 md:p-6 bg-emerald-600 text-white rounded-[1.5rem] hover:bg-emerald-700 transition shadow-2xl shadow-emerald-200 dark:shadow-emerald-900/20 disabled:opacity-50 active:scale-95 group shrink-0",children:e.jsx(W,{className:"h-6 w-6 transition-transform group-hover:translate-x-1 group-hover:-translate-y-1"})})]}),e.jsx("p",{className:"text-[8px] text-center mt-6 text-gray-300 dark:text-slate-700 font-black uppercase tracking-[0.3em]",children:"Always keep transactions within ZimAIO for protection"})]})]}):e.jsxs("div",{className:"flex-1 flex flex-col items-center justify-center p-20 text-center animate-in fade-in duration-1000",children:[e.jsx("div",{className:"w-32 h-32 bg-white dark:bg-slate-800 rounded-[3rem] flex items-center justify-center shadow-2xl shadow-emerald-900/10 mb-10 group hover:scale-110 transition-transform duration-700",children:e.jsx(f,{className:"h-16 w-16 text-emerald-600 group-hover:rotate-12 transition-transform"})}),e.jsx("h3",{className:"text-3xl font-black text-gray-900 dark:text-white uppercase tracking-tighter mb-4",children:"Concierge Support"}),e.jsx("p",{className:"text-[10px] text-gray-400 font-bold max-w-xs uppercase tracking-[0.2em] leading-relaxed",children:"Select a verified vendor channel from the sidebar to establish a direct secure line."}),e.jsxs("div",{className:"mt-12 flex gap-12 opacity-30",children:[e.jsxs("div",{className:"flex flex-col items-center gap-2",children:[e.jsx(y,{className:"w-6 h-6"}),e.jsx("span",{className:"text-[8px] font-black uppercase tracking-widest",children:"Encrypted"})]}),e.jsxs("div",{className:"flex flex-col items-center gap-2",children:[e.jsx(S,{className:"w-6 h-6"}),e.jsx("span",{className:"text-[8px] font-black uppercase tracking-widest",children:"Verified"})]})]})]})})]})})]})}export{Z as MessagesPage};
