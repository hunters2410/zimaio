import{i as te,b as se,e as ae,f as le,r as i,s as g,j as e,h as A,P as B,U,S as V}from"./index-BktnpWS0.js";import re from"./html2canvas.esm-CBrSDip1.js";import{D as ne,E as ie}from"./jspdf.es.min-Bw_9JQnp.js";import{M as ce}from"./maximize-DSH1SQuK.js";import{T as de}from"./trash-2-BZYqHlTV.js";import{M as oe}from"./minus-CUR8ke6T.js";import{P as xe}from"./plus-DKkFzrwN.js";import{X as me}from"./x-Be8cuiWM.js";import{B as he}from"./banknote-WnSVUBld.js";import{C as ue}from"./credit-card-BMxorgaG.js";import{C as pe}from"./circle-check-big-DQYFJHkd.js";/**
 * @license lucide-react v0.562.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const fe=[["path",{d:"M6 18H4a2 2 0 0 1-2-2v-5a2 2 0 0 1 2-2h16a2 2 0 0 1 2 2v5a2 2 0 0 1-2 2h-2",key:"143wyd"}],["path",{d:"M6 9V3a1 1 0 0 1 1-1h10a1 1 0 0 1 1 1v6",key:"1itne7"}],["rect",{x:"6",y:"14",width:"12",height:"8",rx:"1",key:"1ue0tg"}]],W=te("printer",fe);function qe({overrideVendorId:h,onTabChange:N}){var L,I;const{profile:n}=se(),{formatPrice:d}=ae(),{calculatePrice:y}=le(),[G,K]=i.useState([]),[x,u]=i.useState([]),[j,F]=i.useState(""),[H,k]=i.useState(!0),[Q,w]=i.useState(!1),[C,X]=i.useState("cash"),[_,S]=i.useState(!1),[o,q]=i.useState(null),[p,P]=i.useState(h||null),[v,z]=i.useState(""),M=i.useRef(null);i.useEffect(()=>{h&&P(h)},[h]),i.useEffect(()=>{E();const t=s=>{var r;s.key==="f"&&(s.ctrlKey||s.metaKey)&&(s.preventDefault(),(r=M.current)==null||r.focus())};return window.addEventListener("keydown",t),()=>window.removeEventListener("keydown",t)},[n,p]);const E=async()=>{let t=p;if(!t&&(n!=null&&n.id))try{const{data:s}=await g.from("vendor_profiles").select("id, shop_name").eq("user_id",n.id).single();s&&(t=s.id,P(s.id),z(s.shop_name))}catch(s){console.error("Error fetching vendor ID:",s)}if(t)try{if(!v){const{data:l}=await g.from("vendor_profiles").select("shop_name").eq("id",t).single();l&&z(l.shop_name)}const{data:s,error:r}=await g.from("products").select("id, name, base_price, stock_quantity, images, sku").eq("vendor_id",t).eq("is_active",!0).gt("stock_quantity",0).order("name");if(r)throw r;const a=(s||[]).map(l=>{const m=y(l.base_price);return{id:l.id,name:l.name,price:m.total,base_price:l.base_price,stock_quantity:l.stock_quantity,image_url:l.images&&l.images.length>0?l.images[0]:"",sku:l.sku}});K(a)}catch(s){console.error("Error fetching POS products:",s),alert("Terminal Error: Could not fetch products. "+s.message)}finally{k(!1)}else k(!1)},Z=t=>{u(s=>{const r=s.find(a=>a.id===t.id);return r?r.quantity>=t.stock_quantity?s:s.map(a=>a.id===t.id?{...a,quantity:a.quantity+1}:a):[...s,{...t,quantity:1}]})},T=(t,s)=>{u(r=>r.map(a=>{if(a.id===t){const l=Math.max(1,Math.min(a.quantity+s,a.stock_quantity));return{...a,quantity:l}}return a}))},f=x.reduce((t,s)=>t+s.price*s.quantity,0),O=G.filter(t=>{var s;return t.name.toLowerCase().includes(j.toLowerCase())||((s=t.sku)==null?void 0:s.toLowerCase().includes(j.toLowerCase()))}),J=async()=>{if(!(x.length===0||!p)){S(!0);try{const t=`ZIM-${Date.now()}-${Math.floor(Math.random()*1e3)}`;let s=0,r=0,a=0;const l=x.map(c=>{const b=y(c.base_price||c.price);return s+=(c.base_price||c.price)*c.quantity,r+=b.commission*c.quantity,a+=b.vat*c.quantity,{id:c.id,name:c.name,quantity:c.quantity,price:c.price,base_price:c.base_price||c.price,commission:b.commission,vat:b.vat}}),m={order_number:t,vendor_id:p,customer_id:null,total:f,subtotal:s,commission_amount:r,vat_amount:a,status:"delivered",payment_status:"paid",payment_method:C,shipping_address:{type:"POS",details:"Walk-in Customer / POS Store"},items:l},{data:R,error:$}=await g.rpc("create_pos_order",{order_payload:m,items_payload:l});if($)throw $;if(!R)throw new Error("Failed to create order");q(R),u([]),w(!1),E()}catch(t){console.error("Checkout error:",t),alert("Checkout failed: "+t.message)}finally{S(!1)}}},Y=async()=>{if(!o)return;const t=document.getElementById("printable-receipt");if(t)try{const s=await re(t,{scale:3,backgroundColor:"#ffffff",useCORS:!0}),r=s.toDataURL("image/png"),a=new ie({orientation:"portrait",unit:"mm",format:[80,230]}),l=a.internal.pageSize.getWidth(),m=s.height*l/s.width;a.addImage(r,"PNG",0,0,l,m),a.save(`Receipt-${o.order_number}.pdf`)}catch(s){console.error("Error downloading receipt:",s),alert("Could not download receipt. Please try printing instead.")}},[D,ee]=i.useState("register");return H?e.jsx("div",{className:"flex items-center justify-center h-[600px]",children:e.jsx("div",{className:"animate-spin rounded-full h-12 w-12 border-b-2 border-emerald-600"})}):e.jsxs("div",{className:"flex h-screen bg-slate-50 overflow-hidden font-sans text-slate-900",children:[e.jsxs("div",{className:"w-20 md:w-24 bg-slate-900 flex flex-col items-center py-6 gap-8 z-20 shadow-xl",children:[e.jsx("div",{className:"w-10 h-10 bg-emerald-500 rounded-xl flex items-center justify-center text-white shadow-lg shadow-emerald-500/20",children:e.jsx(ce,{size:20,strokeWidth:3})}),e.jsxs("div",{className:"flex flex-col gap-4 w-full px-3",children:[e.jsxs("button",{onClick:()=>ee("register"),className:`p-3 rounded-xl flex flex-col items-center gap-1 transition-all ${D==="register"?"bg-white/10 text-white":"text-slate-500 hover:text-white hover:bg-white/5"}`,children:[e.jsx(A,{size:20}),e.jsx("span",{className:"text-[9px] font-black uppercase tracking-wider",children:"Sell"})]}),e.jsxs("button",{onClick:()=>N&&N("orders"),className:"p-3 rounded-xl flex flex-col items-center gap-1 text-slate-500 hover:text-white hover:bg-white/5 transition-all",children:[e.jsx(B,{size:20}),e.jsx("span",{className:"text-[9px] font-black uppercase tracking-wider",children:"Orders"})]}),e.jsxs("button",{className:"p-3 rounded-xl flex flex-col items-center gap-1 text-slate-500 hover:text-white hover:bg-white/5 transition-all",children:[e.jsx(U,{size:20}),e.jsx("span",{className:"text-[9px] font-black uppercase tracking-wider",children:"Cust."})]})]}),e.jsx("div",{className:"mt-auto flex flex-col gap-4 w-full px-3",children:e.jsx("button",{className:"p-3 rounded-xl flex flex-col items-center gap-1 text-slate-500 hover:text-white hover:bg-white/5 transition-all",children:e.jsx(W,{size:20})})})]}),e.jsxs("div",{className:"flex-1 flex flex-col min-w-0",children:[e.jsxs("div",{className:"h-16 bg-white border-b border-slate-200 flex items-center justify-between px-6 md:px-8 shadow-sm z-10",children:[e.jsxs("div",{className:"flex items-center gap-4",children:[e.jsx("h1",{className:"text-xl font-black uppercase tracking-tight text-slate-900",children:v||"POS Terminal"}),e.jsx("div",{className:"h-6 w-px bg-slate-200"}),e.jsxs("div",{className:"flex items-center gap-2 text-slate-400",children:[e.jsx("span",{className:"w-2 h-2 rounded-full bg-emerald-500 animate-pulse"}),e.jsx("span",{className:"text-xs font-bold uppercase tracking-wider",children:"Online"})]})]}),e.jsxs("div",{className:"flex items-center gap-4",children:[e.jsxs("div",{className:"hidden md:flex items-center bg-slate-100 rounded-full px-4 py-2 border border-slate-200",children:[e.jsx(V,{className:"h-4 w-4 text-slate-400 mr-2"}),e.jsx("input",{type:"text",placeholder:"Global Search...",className:"bg-transparent border-none outline-none text-xs font-bold text-slate-700 w-48 placeholder:text-slate-400"})]}),e.jsxs("div",{className:"flex items-center gap-3 pl-4 border-l border-slate-200",children:[e.jsxs("div",{className:"text-right hidden md:block",children:[e.jsx("p",{className:"text-xs font-black text-slate-900",children:n==null?void 0:n.full_name}),e.jsx("p",{className:"text-[10px] text-slate-400 font-bold uppercase",children:n==null?void 0:n.role})]}),e.jsx("div",{className:"w-9 h-9 bg-indigo-100 rounded-full flex items-center justify-center text-indigo-600 font-black text-xs border border-indigo-200",children:(L=n==null?void 0:n.email)==null?void 0:L.charAt(0).toUpperCase()})]})]})]}),e.jsx("div",{className:"flex-1 overflow-hidden p-4 md:p-6",children:D==="register"&&e.jsxs("div",{className:"h-full flex flex-col lg:flex-row gap-6",children:[e.jsxs("div",{className:"flex-1 flex flex-col bg-white rounded-2xl border border-slate-200 overflow-hidden shadow-sm",children:[e.jsxs("div",{className:"p-4 border-b border-slate-100 flex gap-4",children:[e.jsxs("div",{className:"relative flex-1",children:[e.jsx(V,{className:"absolute left-4 top-1/2 -translate-y-1/2 w-4 h-4 text-slate-400"}),e.jsx("input",{ref:M,type:"text",placeholder:"Search products...",value:j,onChange:t=>F(t.target.value),className:"w-full bg-slate-50 border border-slate-200 focus:border-emerald-500 rounded-xl py-3 pl-10 pr-4 text-xs font-bold outline-none transition-all"})]}),e.jsxs("div",{className:"flex items-center gap-2 px-4 bg-slate-50 rounded-xl border border-slate-200",children:[e.jsx(B,{size:16,className:"text-slate-400"}),e.jsx("span",{className:"text-xs font-black text-slate-700",children:O.length})]})]}),e.jsx("div",{className:"flex-1 overflow-y-auto p-4 bg-slate-50/50",children:e.jsx("div",{className:"grid grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-4",children:O.map(t=>e.jsxs("button",{onClick:()=>Z(t),className:"group bg-white rounded-xl p-3 border border-slate-200 hover:border-emerald-500 hover:shadow-md transition-all text-left flex flex-col h-full",children:[e.jsxs("div",{className:"w-full aspect-square rounded-lg bg-slate-100 mb-3 overflow-hidden relative",children:[t.image_url?e.jsx("img",{src:t.image_url,alt:t.name,className:"w-full h-full object-cover"}):e.jsx("div",{className:"w-full h-full flex items-center justify-center text-slate-300 font-black text-xl",children:"IMG"}),e.jsx("div",{className:"absolute top-2 right-2 bg-slate-900/80 text-white text-[9px] font-bold px-1.5 py-0.5 rounded backdrop-blur-sm",children:t.stock_quantity})]}),e.jsx("h3",{className:"font-bold text-slate-800 text-xs leading-snug line-clamp-2 mb-1 group-hover:text-emerald-600 transition-colors",children:t.name}),e.jsx("p",{className:"text-[10px] font-medium text-slate-400 mb-2",children:t.sku}),e.jsx("div",{className:"mt-auto font-black text-sm text-slate-900",children:d(t.price)})]},t.id))})})]}),e.jsxs("div",{className:"w-full lg:w-[400px] bg-white rounded-2xl border border-slate-200 flex flex-col shadow-xl shadow-slate-200/50 h-[calc(100vh-140px)] lg:h-auto",children:[e.jsxs("div",{className:"p-5 border-b border-slate-100 flex items-center justify-between bg-slate-50/50 rounded-t-2xl",children:[e.jsxs("h2",{className:"text-sm font-black uppercase tracking-wide text-slate-900 flex items-center gap-2",children:[e.jsx("div",{className:"w-2 h-2 rounded-full bg-emerald-500"}),"Current Order"]}),e.jsx("button",{onClick:()=>u([]),className:"text-slate-400 hover:text-red-500 transition-colors",children:e.jsx(de,{size:16})})]}),e.jsxs("div",{className:"flex-1 overflow-y-auto p-4 space-y-3",children:[x.map(t=>e.jsxs("div",{className:"flex gap-3 bg-white border border-slate-100 p-2 rounded-xl group hover:border-slate-200 transition-all",children:[e.jsx("div",{className:"w-12 h-12 bg-slate-100 rounded-lg shrink-0 overflow-hidden",children:e.jsx("img",{src:t.image_url,className:"w-full h-full object-cover"})}),e.jsxs("div",{className:"flex-1 min-w-0",children:[e.jsxs("div",{className:"flex justify-between items-start",children:[e.jsx("p",{className:"text-xs font-bold text-slate-900 truncate pr-2",children:t.name}),e.jsx("p",{className:"text-xs font-black text-slate-900",children:d(t.price*t.quantity)})]}),e.jsxs("div",{className:"flex items-center justify-between mt-2",children:[e.jsxs("p",{className:"text-[10px] text-slate-400",children:[d(t.price)," x ",t.quantity]}),e.jsxs("div",{className:"flex items-center gap-1 bg-slate-50 rounded-lg p-0.5 border border-slate-100",children:[e.jsx("button",{onClick:()=>T(t.id,-1),className:"p-1 hover:bg-white rounded shadow-sm text-slate-500",children:e.jsx(oe,{size:10})}),e.jsx("span",{className:"text-[10px] font-bold w-4 text-center",children:t.quantity}),e.jsx("button",{onClick:()=>T(t.id,1),className:"p-1 hover:bg-white rounded shadow-sm text-slate-500",children:e.jsx(xe,{size:10})})]})]})]})]},t.id)),x.length===0&&e.jsxs("div",{className:"h-full flex flex-col items-center justify-center text-slate-300",children:[e.jsx(A,{size:32,className:"mb-2 opacity-50"}),e.jsx("p",{className:"text-[10px] font-bold uppercase tracking-widest",children:"Cart Empty"})]})]}),e.jsxs("div",{className:"p-5 bg-slate-50 border-t border-slate-100 rounded-b-2xl",children:[e.jsxs("div",{className:"space-y-2 mb-4",children:[e.jsxs("div",{className:"flex justify-between text-xs text-slate-500",children:[e.jsx("span",{children:"Subtotal"}),e.jsx("span",{className:"font-bold",children:d(f)})]}),e.jsxs("div",{className:"flex justify-between text-xs text-slate-500",children:[e.jsx("span",{children:"Tax"}),e.jsx("span",{className:"font-bold",children:"$0.00"})]}),e.jsxs("div",{className:"flex justify-between text-lg font-black text-slate-900 pt-2 border-t border-slate-200",children:[e.jsx("span",{children:"Total"}),e.jsx("span",{className:"text-emerald-600",children:d(f)})]})]}),e.jsx("button",{disabled:x.length===0,onClick:()=>w(!0),className:"w-full py-4 bg-slate-900 text-white rounded-xl text-xs font-black uppercase tracking-widest hover:bg-black transition-all shadow-lg shadow-slate-200 disabled:opacity-50 disabled:cursor-not-allowed",children:"Checkout"})]})]})]})})]}),Q&&e.jsx("div",{className:"fixed inset-0 z-[100] flex items-center justify-center px-4 bg-slate-900/40 backdrop-blur-sm animate-in fade-in duration-200",children:e.jsxs("div",{className:"bg-white w-full max-w-md rounded-2xl overflow-hidden shadow-2xl animate-in zoom-in-95 duration-200 border border-slate-200",children:[e.jsxs("div",{className:"p-6 border-b border-slate-100 flex items-center justify-between",children:[e.jsx("h3",{className:"text-lg font-black text-slate-900 uppercase tracking-tight",children:"Checkout"}),e.jsx("button",{onClick:()=>w(!1),className:"text-slate-400 hover:text-slate-700",children:e.jsx(me,{size:20})})]}),e.jsxs("div",{className:"p-6 space-y-6",children:[e.jsx("div",{className:"grid grid-cols-3 gap-3",children:[{id:"cash",label:"Cash",icon:e.jsx(he,{size:20})},{id:"card",label:"Card",icon:e.jsx(ue,{size:20})},{id:"transfer",label:"Other",icon:e.jsx(U,{size:20})}].map(t=>e.jsxs("button",{onClick:()=>X(t.id),className:`flex flex-col items-center gap-2 p-4 rounded-xl border-2 transition-all ${C===t.id?"border-emerald-500 bg-emerald-50 text-emerald-600":"border-slate-100 bg-slate-50 text-slate-400"}`,children:[t.icon,e.jsx("span",{className:"text-[10px] font-black uppercase",children:t.label})]},t.id))}),e.jsxs("div",{className:"text-center py-4",children:[e.jsx("p",{className:"text-xs font-bold text-slate-400 uppercase tracking-widest",children:"Amount Due"}),e.jsx("p",{className:"text-4xl font-black text-slate-900 mt-1",children:d(f)})]}),e.jsx("button",{onClick:J,disabled:_,className:"w-full py-4 bg-emerald-600 text-white rounded-xl text-xs font-black uppercase tracking-widest hover:bg-emerald-700 transition-all shadow-lg shadow-emerald-200",children:_?"Processing...":"Complete Sale"})]})]})}),o&&e.jsx("div",{className:"fixed inset-0 z-[110] flex items-center justify-center px-4 bg-slate-900/50 backdrop-blur-sm animate-in fade-in",children:e.jsxs("div",{className:"bg-white w-full max-w-sm rounded-[32px] overflow-hidden shadow-2xl flex flex-col max-h-[90vh]",children:[e.jsxs("div",{className:"bg-emerald-500 p-6 text-center text-white shrink-0",children:[e.jsx("div",{className:"w-12 h-12 bg-white/20 rounded-full flex items-center justify-center mx-auto mb-3 backdrop-blur-sm",children:e.jsx(pe,{size:24})}),e.jsx("h2",{className:"text-xl font-black uppercase tracking-tight",children:"Payment Success"})]}),e.jsxs("div",{className:"p-6 overflow-y-auto bg-slate-50 flex flex-col items-center",children:[e.jsxs("div",{id:"printable-receipt",className:"bg-white p-6 w-full shadow-sm border border-gray-100 text-center relative mb-6",children:[e.jsxs("div",{className:"border-b-2 border-dashed border-gray-200 pb-4 mb-4 text-center",children:[e.jsx("h3",{className:"font-black text-slate-900 uppercase text-lg leading-none mb-1",children:v||"Store Receipt"}),e.jsx("p",{className:"text-[10px] text-slate-400 font-bold uppercase tracking-widest",children:new Date().toLocaleString()}),e.jsxs("p",{className:"text-[10px] text-slate-400 font-bold uppercase tracking-widest mt-0.5",children:["Order #",o.order_number]})]}),e.jsx("div",{className:"space-y-3 mb-4 text-left min-h-[60px]",children:(I=o.items)==null?void 0:I.map((t,s)=>e.jsxs("div",{className:"flex justify-between items-start text-xs font-bold text-slate-700",children:[e.jsxs("div",{className:"flex flex-col",children:[e.jsx("span",{children:t.name}),e.jsxs("span",{className:"text-[10px] text-slate-400",children:["x",t.quantity," @ ",d(t.price)]})]}),e.jsx("span",{children:d(t.price*t.quantity)})]},s))}),e.jsxs("div",{className:"border-t-2 border-dashed border-gray-200 pt-4 space-y-1",children:[e.jsxs("div",{className:"flex justify-between text-[10px] font-black text-slate-400 uppercase tracking-widest",children:[e.jsx("span",{children:"Subtotal"}),e.jsx("span",{children:d(o.subtotal)})]}),e.jsxs("div",{className:"flex justify-between text-base font-black text-slate-900 uppercase tracking-tight mt-2",children:[e.jsx("span",{children:"Total Paid"}),e.jsx("span",{children:d(o.total)})]})]}),e.jsx("div",{className:"mt-6 pt-4 border-t border-gray-100 text-center",children:e.jsx("p",{className:"text-[9px] text-slate-400 font-bold uppercase tracking-widest",children:"Thank you for your business!"})})]}),e.jsxs("div",{className:"grid grid-cols-2 gap-3 w-full",children:[e.jsxs("button",{onClick:Y,className:"py-3 bg-slate-900 text-white rounded-xl text-[10px] font-black uppercase tracking-wider hover:bg-black transition-all flex items-center justify-center gap-2",children:[e.jsx(ne,{size:16})," Save PDF"]}),e.jsxs("button",{onClick:()=>window.print(),className:"py-3 bg-white border border-gray-200 text-slate-700 rounded-xl text-[10px] font-black uppercase tracking-wider hover:bg-gray-50 transition-all flex items-center justify-center gap-2",children:[e.jsx(W,{size:16})," Print"]}),e.jsx("button",{onClick:()=>q(null),className:"col-span-2 py-3 bg-emerald-50 border border-emerald-100 text-emerald-700 rounded-xl text-[10px] font-black uppercase tracking-wider hover:bg-emerald-100 transition-all",children:"Start New Order"})]})]})]})})]})}export{qe as V};
