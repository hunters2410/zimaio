import{v as q,u as M,r,s as h,j as e,n as E,S as T}from"./index-BktnpWS0.js";import{A as U}from"./AdminLayout-C6Mn2_Yu.js";import{S as R}from"./shield-QBrICIHj.js";import{P as O}from"./plus-DKkFzrwN.js";import{X as k}from"./x-Be8cuiWM.js";import{S as B}from"./square-pen-RrpnH1Wm.js";import{U as D}from"./users-vNuzB1jC.js";import{T as z}from"./trash-2-BZYqHlTV.js";import"./chevron-left-AWoZAuKB.js";import"./triangle-alert-HMuOKNOn.js";import"./circle-check-big-DQYFJHkd.js";import"./chevron-right-peYPGYwP.js";import"./zap-CpGj1Zaf.js";import"./maximize-DSH1SQuK.js";import"./store-DDL7ZG_8.js";import"./file-text-DIHdwLby.js";import"./globe-CdXxteOx.js";import"./truck-CO3939ut.js";import"./credit-card-BMxorgaG.js";import"./settings-D3GsvmJN.js";import"./trending-up-wuknMfwd.js";function me(){const{theme:p}=q(),N=M(),a=p==="dark",[v,A]=r.useState([]),[w,$]=r.useState(!0),[f,_]=r.useState(""),[u,b]=r.useState(null),[g,d]=r.useState(null),[y,l]=r.useState(!1);r.useEffect(()=>{S()},[]);const S=async()=>{$(!0);try{const{data:s,error:n}=await h.from("user_roles").select("*").order("created_at",{ascending:!1});if(n)throw n;A(s||[])}catch(s){d({type:"error",text:s.message})}finally{$(!1)}},i=async(s,n)=>{if(confirm(`Are you sure you want to delete the role "${n}"? This action cannot be undone.`))try{const{error:o}=await h.from("user_roles").delete().eq("id",s);if(o)throw o;d({type:"success",text:"Role deleted successfully"}),S()}catch(o){d({type:"error",text:o.message||"Failed to delete role"})}},j=()=>{l(!1),b(null)},m=v.filter(s=>{var n,o;return((n=s.role_name)==null?void 0:n.toLowerCase().includes(f.toLowerCase()))||((o=s.role_description)==null?void 0:o.toLowerCase().includes(f.toLowerCase()))}),x=a?"bg-gray-800":"bg-white",C=a?"text-gray-100":"text-gray-900",c=a?"text-gray-400":"text-gray-600",t=a?"border-gray-700":"border-gray-200";return w&&v.length===0?e.jsx(U,{children:e.jsx("div",{className:"flex items-center justify-center h-64",children:e.jsx("div",{className:"animate-spin rounded-full h-12 w-12 border-b-2 border-cyan-600"})})}):e.jsxs(U,{children:[e.jsx("div",{className:"mb-8",children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{children:[e.jsxs("h1",{className:`text-3xl font-bold ${C} flex items-center gap-2`,children:[e.jsx(R,{className:"h-8 w-8 text-cyan-600"}),"Roles & Permissions"]}),e.jsx("p",{className:c,children:"Manage system roles and permissions"})]}),e.jsxs("button",{onClick:()=>N("/admin/roles-permissions/new"),className:"flex items-center space-x-2 px-4 py-2 bg-gradient-to-r from-cyan-600 to-green-600 text-white rounded-lg hover:from-cyan-700 hover:to-green-700 transition",children:[e.jsx(O,{className:"h-5 w-5"}),e.jsx("span",{children:"Create Role"})]})]})}),g&&e.jsxs("div",{className:`mb-6 p-4 rounded-lg flex items-start space-x-3 ${g.type==="success"?"bg-green-50 border border-green-200 text-green-800":"bg-red-50 border border-red-200 text-red-800"}`,children:[e.jsx(E,{className:"h-5 w-5 flex-shrink-0 mt-0.5"}),e.jsx("span",{children:g.text}),e.jsx("button",{onClick:()=>d(null),className:"ml-auto",children:e.jsx(k,{className:"h-4 w-4"})})]}),e.jsx("div",{className:`${x} rounded-lg shadow-sm p-6 mb-6`,children:e.jsxs("div",{className:"relative",children:[e.jsx(T,{className:`absolute left-3 top-1/2 transform -translate-y-1/2 ${c} h-5 w-5`}),e.jsx("input",{type:"text",placeholder:"Search roles...",value:f,onChange:s=>_(s.target.value),className:`w-full pl-10 pr-4 py-2 border ${t} rounded-lg focus:outline-none focus:ring-2 focus:ring-cyan-500 ${a?"bg-gray-700 text-gray-100":"bg-white"}`})]})}),e.jsx("div",{className:"grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6",children:m.map(s=>e.jsxs("div",{className:`${x} rounded-lg shadow-sm p-6 border ${t}`,children:[e.jsx("div",{className:"flex items-start justify-between mb-4",children:e.jsxs("div",{className:"flex-1",children:[e.jsxs("div",{className:"flex items-center gap-2 mb-2",children:[e.jsx(R,{className:"h-5 w-5 text-cyan-600"}),e.jsx("h3",{className:`text-lg font-semibold ${C}`,children:s.role_name})]}),e.jsx("p",{className:`text-sm ${c} mb-3`,children:s.role_description}),e.jsx("span",{className:`px-2 py-1 text-xs rounded-full ${s.is_active?"bg-green-100 text-green-800":"bg-red-100 text-red-800"}`,children:s.is_active?"Active":"Inactive"})]})}),e.jsxs("div",{className:"mb-4",children:[e.jsx("p",{className:`text-xs font-medium ${c} mb-2`,children:"Permissions Summary:"}),e.jsx("div",{className:"flex flex-wrap gap-1",children:Object.entries(s.permissions||{}).map(([n,o])=>{const P=Object.entries(o).filter(([I,L])=>L).length;return P>0?e.jsxs("span",{className:"px-2 py-1 text-xs bg-cyan-100 text-cyan-800 rounded",children:[n," (",P,")"]},n):null})})]}),e.jsxs("div",{className:"flex items-center gap-2 pt-4 border-t border-gray-200 dark:border-gray-700",children:[e.jsxs("button",{onClick:()=>N(`/admin/roles-permissions/edit/${s.id}`),className:"flex-1 flex items-center justify-center gap-2 px-3 py-2 text-sm bg-cyan-50 text-cyan-700 rounded-lg hover:bg-cyan-100 transition",children:[e.jsx(B,{className:"h-4 w-4"}),"Edit"]}),e.jsxs("button",{onClick:()=>{b(s),l(!0)},className:"flex-1 flex items-center justify-center gap-2 px-3 py-2 text-sm bg-green-50 text-green-700 rounded-lg hover:bg-green-100 transition",children:[e.jsx(D,{className:"h-4 w-4"}),"Assign"]}),e.jsx("button",{onClick:()=>i(s.id,s.role_name),className:"px-3 py-2 text-sm bg-red-50 text-red-700 rounded-lg hover:bg-red-100 transition",children:e.jsx(z,{className:"h-4 w-4"})})]})]},s.id))}),m.length===0&&e.jsxs("div",{className:`${x} rounded-lg shadow-sm p-12 text-center`,children:[e.jsx(R,{className:`h-12 w-12 ${c} mx-auto mb-4`}),e.jsx("p",{className:`${c} mb-4`,children:"No roles found"})]}),y&&u&&e.jsx(F,{role:u,onClose:j,isDark:a})]})}function F({role:p,onClose:N,isDark:a}){const[v,A]=r.useState([]),[w,$]=r.useState([]),[f,_]=r.useState(!0),[u,b]=r.useState(""),[g,d]=r.useState(""),[y,l]=r.useState(null),S=a?"bg-gray-800":"bg-white",i=a?"text-gray-100":"text-gray-900",j=a?"text-gray-400":"text-gray-600",m=a?"border-gray-700":"border-gray-200";r.useEffect(()=>{x()},[]);const x=async()=>{_(!0);try{const[t,s]=await Promise.all([h.from("profiles").select("id, email, full_name, role").eq("role","admin"),h.from("user_role_assignments").select(`
            *,
            user:profiles!user_role_assignments_user_id_fkey(id, email, full_name)
          `).eq("role_id",p.id)]);if(t.error)throw t.error;if(s.error)throw s.error;A(t.data||[]),$(s.data||[])}catch(t){l({type:"error",text:t.message})}finally{_(!1)}},C=async t=>{if(t.preventDefault(),!!u)try{const{error:s}=await h.from("user_role_assignments").insert({user_id:u,role_id:p.id,expires_at:g||null});if(s)throw s;l({type:"success",text:"Role assigned successfully"}),b(""),d(""),x()}catch(s){l({type:"error",text:s.message})}},c=async t=>{try{const{error:s}=await h.from("user_role_assignments").delete().eq("id",t);if(s)throw s;l({type:"success",text:"Role unassigned successfully"}),x()}catch(s){l({type:"error",text:s.message})}};return e.jsx("div",{className:"fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4",children:e.jsxs("div",{className:`${S} rounded-lg shadow-xl max-w-2xl w-full max-h-[90vh] overflow-y-auto`,children:[e.jsxs("div",{className:`p-6 border-b ${m} flex items-center justify-between`,children:[e.jsxs("h2",{className:`text-2xl font-bold ${i}`,children:["Assign Role: ",p.role_name]}),e.jsx("button",{onClick:N,className:`${j} hover:text-gray-600 transition`,children:e.jsx(k,{className:"h-6 w-6"})})]}),e.jsxs("div",{className:"p-6",children:[y&&e.jsxs("div",{className:`mb-6 p-4 rounded-lg flex items-start space-x-3 ${y.type==="success"?"bg-green-50 border border-green-200 text-green-800":"bg-red-50 border border-red-200 text-red-800"}`,children:[e.jsx(E,{className:"h-5 w-5 flex-shrink-0 mt-0.5"}),e.jsx("span",{children:y.text}),e.jsx("button",{onClick:()=>l(null),className:"ml-auto",children:e.jsx(k,{className:"h-4 w-4"})})]}),e.jsxs("form",{onSubmit:C,className:"mb-6",children:[e.jsx("h3",{className:`text-lg font-semibold ${i} mb-4`,children:"Assign to User"}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4 mb-4",children:[e.jsxs("div",{children:[e.jsx("label",{className:`block text-sm font-medium ${i} mb-1`,children:"Select User *"}),e.jsxs("select",{required:!0,value:u,onChange:t=>b(t.target.value),className:`w-full px-3 py-2 border ${m} rounded-lg focus:outline-none focus:ring-2 focus:ring-cyan-500 ${a?"bg-gray-700 text-gray-100":"bg-white"}`,children:[e.jsx("option",{value:"",children:"Choose user..."}),v.map(t=>e.jsx("option",{value:t.id,children:t.full_name||t.email},t.id))]})]}),e.jsxs("div",{children:[e.jsx("label",{className:`block text-sm font-medium ${i} mb-1`,children:"Expires At (Optional)"}),e.jsx("input",{type:"date",value:g,onChange:t=>d(t.target.value),className:`w-full px-3 py-2 border ${m} rounded-lg focus:outline-none focus:ring-2 focus:ring-cyan-500 ${a?"bg-gray-700 text-gray-100":"bg-white"}`})]})]}),e.jsx("button",{type:"submit",disabled:f,className:"w-full px-4 py-2 bg-gradient-to-r from-cyan-600 to-green-600 text-white rounded-lg hover:from-cyan-700 hover:to-green-700 transition",children:"Assign Role"})]}),e.jsxs("div",{children:[e.jsx("h3",{className:`text-lg font-semibold ${i} mb-4`,children:"Current Assignments"}),w.length===0?e.jsx("p",{className:`text-center py-8 ${j}`,children:"No users assigned to this role"}):e.jsx("div",{className:"space-y-2",children:w.map(t=>{var s,n;return e.jsxs("div",{className:`flex items-center justify-between p-3 border ${m} rounded-lg`,children:[e.jsxs("div",{children:[e.jsx("p",{className:`font-medium ${i}`,children:((s=t.user)==null?void 0:s.full_name)||((n=t.user)==null?void 0:n.email)}),t.expires_at&&e.jsxs("p",{className:`text-sm ${j}`,children:["Expires: ",new Date(t.expires_at).toLocaleDateString()]})]}),e.jsx("button",{onClick:()=>c(t.id),className:"px-3 py-1 text-sm bg-red-50 text-red-700 rounded hover:bg-red-100",children:"Remove"})]},t.id)})})]})]})]})})}export{me as RolesPermissions};
