import{s as l}from"./index-T9wcIP7k.js";let t=l;const u={setSupabase(e){t=e},async getActiveGateways(){const{data:e,error:o}=await t.from("payment_gateways").select("*").eq("is_active",!0).order("sort_order",{ascending:!0});if(o)throw o;return e||[]},async getAllGateways(){const{data:e,error:o}=await t.from("payment_gateways").select("*").order("sort_order",{ascending:!0});if(o)throw o;return e||[]},async getGatewayById(e){const{data:o,error:r}=await t.from("payment_gateways").select("*").eq("id",e).maybeSingle();if(r)throw r;return o},async updateGateway(e,o){const{data:r,error:a}=await t.from("payment_gateways").update(o).eq("id",e).select();if(a)throw a;if(!r||r.length===0)throw new Error("Update failed: Record not found or permission denied. Check if you have administrator roles assigned.")},async createManualGateway(e){const{data:o,error:r}=await t.from("payment_gateways").insert({gateway_name:e.gateway_name,gateway_type:"manual",display_name:e.display_name,description:e.description,is_active:e.is_active,is_default:!1,configuration:e.configuration||{},supported_currencies:e.supported_currencies,instructions:e.instructions,logo_url:e.logo_url,sort_order:e.sort_order}).select().single();if(r)throw r;return o},async deleteGateway(e){const{error:o}=await t.from("payment_gateways").delete().eq("id",e);if(o)throw o},async getInstructions(e){const{data:o,error:r}=await t.from("payment_instructions").select("*").eq("gateway_id",e).order("step_number",{ascending:!0});if(r)throw r;return o||[]},async saveInstructions(e,o){if(await t.from("payment_instructions").delete().eq("gateway_id",e),o.length>0){const{error:r}=await t.from("payment_instructions").insert(o.map(a=>({gateway_id:e,step_number:a.step_number,title:a.title,description:a.description})));if(r)throw r}},async createTransaction(e){const{data:o,error:r}=await t.from("payment_transactions").insert(e).select().single();if(r)throw r;return o},async updateTransaction(e,o){const{data:r,error:a}=await t.from("payment_transactions").update(o).eq("id",e).select();if(a)throw a;if(!r||r.length===0)throw new Error("Update failed: Transaction not found or permission denied.")},async getTransactionById(e){const{data:o,error:r}=await t.from("payment_transactions").select("*").eq("id",e).maybeSingle();if(r)throw r;return o},async getUserTransactions(e){const{data:o,error:r}=await t.from("payment_transactions").select("*").eq("user_id",e).order("created_at",{ascending:!1});if(r)throw r;return o||[]},async getAllTransactions(){const{data:e,error:o}=await t.from("payment_transactions").select("*").order("created_at",{ascending:!1});if(o)throw o;return e||[]},async initiatePayment(e){console.log("üîê Initiating payment - checking authentication...");const o=`${t.supabaseUrl}/functions/v1/process-payment`;console.log("üìç API URL:",o);const{data:{session:r},error:a}=await t.auth.getSession();if(a)throw console.error("‚ùå Session error:",a),new Error("Failed to get authentication session. Please refresh the page and try again.");if(!r)throw console.error("‚ùå No session found"),new Error("User not authenticated. Please log in to continue with payment.");if(!r.access_token)throw console.error("‚ùå Session exists but no access token"),new Error("Invalid session. Please log out and log in again.");console.log("‚úÖ Session valid"),console.log("   User ID:",r.user.id),console.log("   Token preview:",r.access_token.substring(0,20)+"..."),console.log("   Token expires:",new Date(r.expires_at*1e3).toLocaleString());const c=Math.floor(Date.now()/1e3);if(r.expires_at&&r.expires_at<c){console.warn("‚ö†Ô∏è  Token appears to be expired, refreshing...");const{data:n,error:s}=await t.auth.refreshSession();if(s||!n.session)throw console.error("‚ùå Token refresh failed:",s),new Error("Session expired. Please log out and log in again.");console.log("‚úÖ Token refreshed successfully")}console.log("üì§ Sending payment request..."),console.log("   Order ID:",e.order_id),console.log("   Gateway:",e.gateway_type),console.log("   Amount:",e.amount),console.log("   Currency:",e.currency);try{const n=await fetch(o,{method:"POST",headers:{Authorization:`Bearer ${r.access_token}`,"Content-Type":"application/json",apikey:t.supabaseKey},body:JSON.stringify(e)});console.log("üì• Response received:"),console.log("   Status:",n.status,n.statusText),console.log("   Headers:",Object.fromEntries(n.headers.entries()));const s=await n.text();console.log("   Raw response:",s);let i;try{i=JSON.parse(s)}catch{throw console.error("‚ùå Failed to parse response as JSON"),new Error(`Invalid response from server: ${s}`)}if(!n.ok)throw console.error("‚ùå API returned error:"),console.error(i),new Error(i.error||i.message||"Payment initiation failed");return console.log("‚úÖ Payment API call successful"),console.log(i),i}catch(n){throw console.error("‚ùå Fetch error:"),console.error(n),n.message.includes("Failed to fetch")?new Error("Network error. Please check your internet connection and try again."):n}}};export{u as p};
