import{b as $,u as L,r as i,s as l,j as e,S as T,k as j}from"./index-BktnpWS0.js";import{A as V}from"./arrow-left-DLErrt3f.js";import{S as v}from"./store-DDL7ZG_8.js";import{C as I}from"./circle-Bl7k3hc2.js";import{S as O}from"./send-Ywos9H0t.js";function W(){const{user:t}=$(),m=L(),[x,h]=i.useState([]),[a,y]=i.useState(null),[g,f]=i.useState([]),[c,u]=i.useState(""),[N,_]=i.useState(!0),[S,p]=i.useState(!1),b=i.useRef(null);i.useEffect(()=>{t!=null&&t.id?(w(),C()):m("/login")},[t==null?void 0:t.id]),i.useEffect(()=>{a&&(E(a.id),q(a.id))},[a]),i.useEffect(()=>{k()},[g]);const k=()=>{var s;(s=b.current)==null||s.scrollIntoView({behavior:"smooth"})},C=()=>{const s=l.channel("customer_chat_changes").on("postgres_changes",{event:"*",schema:"public",table:"chat_messages"},r=>{a&&r.new&&r.new.conversation_id===a.id&&f(n=>[...n,r.new]),w()}).subscribe();return()=>{l.removeChannel(s)}},w=async()=>{try{const{data:s,error:r}=await l.from("chat_conversations").select("*").contains("participant_ids",[t==null?void 0:t.id]).order("last_message_at",{ascending:!1});if(r)throw r;const n=await Promise.all((s||[]).map(async d=>{const A=d.participant_ids.find(R=>R!==(t==null?void 0:t.id)),{data:o}=await l.from("vendor_profiles").select("shop_name, shop_logo_url").eq("user_id",A).single(),{count:P}=await l.from("chat_messages").select("*",{count:"exact",head:!0}).eq("conversation_id",d.id).eq("is_read",!1).neq("sender_id",t==null?void 0:t.id);return{...d,vendor_name:(o==null?void 0:o.shop_name)||"Premium Vendor",vendor_logo:o==null?void 0:o.shop_logo_url,unread_count:P||0}}));h(n)}catch(s){console.error("Error fetching conversations:",s)}finally{_(!1)}},E=async s=>{try{const{data:r,error:n}=await l.from("chat_messages").select("*").eq("conversation_id",s).order("created_at",{ascending:!0});if(n)throw n;f(r||[])}catch(r){console.error("Error fetching messages:",r)}},q=async s=>{await l.from("chat_messages").update({is_read:!0}).eq("conversation_id",s).neq("sender_id",t==null?void 0:t.id),h(r=>r.map(n=>n.id===s?{...n,unread_count:0}:n))},M=async s=>{if(s.preventDefault(),!(!c.trim()||!a||!(t!=null&&t.id))){p(!0);try{const r={conversation_id:a.id,sender_id:t.id,message:c.trim()},{error:n}=await l.from("chat_messages").insert(r);if(n)throw n;await l.from("chat_conversations").update({last_message:c.trim(),last_message_at:new Date().toISOString()}).eq("id",a.id),u("")}catch(r){console.error("Error sending message:",r)}finally{p(!1)}}};return N?e.jsx("div",{className:"min-h-screen flex items-center justify-center bg-gray-50",children:e.jsx("div",{className:"animate-spin rounded-full h-12 w-12 border-b-2 border-emerald-600"})}):e.jsxs("div",{className:"min-h-screen bg-gray-50",children:[e.jsx("div",{className:"bg-white border-b border-gray-100",children:e.jsx("div",{className:"container mx-auto px-4 py-8",children:e.jsxs("div",{className:"flex items-center gap-4",children:[e.jsx("button",{onClick:()=>m(-1),className:"p-2 hover:bg-gray-50 rounded-xl transition-colors",children:e.jsx(V,{className:"w-5 h-5 text-gray-500"})}),e.jsxs("div",{children:[e.jsx("h1",{className:"text-2xl font-black text-gray-900 uppercase tracking-tight",children:"Support Concierge"}),e.jsx("p",{className:"text-[10px] text-gray-400 font-bold uppercase tracking-widest",children:"Your direct line to premium vendors"})]})]})})}),e.jsx("div",{className:"container mx-auto px-4 py-8",children:e.jsxs("div",{className:"bg-white rounded-[2.5rem] border border-gray-100 shadow-xl shadow-emerald-900/5 overflow-hidden flex h-[700px]",children:[e.jsxs("div",{className:"w-80 border-r border-gray-50 flex flex-col bg-white",children:[e.jsx("div",{className:"p-6 border-b border-gray-50",children:e.jsxs("div",{className:"relative",children:[e.jsx(T,{className:"absolute left-3 top-1/2 -translate-y-1/2 h-4 w-4 text-gray-400"}),e.jsx("input",{type:"text",placeholder:"Search chats...",className:"w-full pl-10 pr-4 py-2.5 bg-gray-50 border-none rounded-xl text-xs focus:ring-2 focus:ring-emerald-500 outline-none font-bold italic"})]})}),e.jsx("div",{className:"flex-1 overflow-y-auto custom-scrollbar",children:x.length===0?e.jsxs("div",{className:"p-12 text-center",children:[e.jsx("div",{className:"w-16 h-16 bg-gray-50 rounded-[1.5rem] flex items-center justify-center mx-auto mb-4",children:e.jsx(j,{className:"h-8 w-8 text-gray-200"})}),e.jsx("p",{className:"text-[10px] font-black text-gray-400 uppercase tracking-widest",children:"Start a conversation"})]}):e.jsx("div",{className:"divide-y divide-gray-50",children:x.map(s=>e.jsxs("button",{onClick:()=>y(s),className:`w-full p-6 flex items-start gap-4 hover:bg-emerald-50/30 transition-all text-left ${(a==null?void 0:a.id)===s.id?"bg-emerald-50 border-r-4 border-emerald-500":""}`,children:[e.jsx("div",{className:"w-12 h-12 bg-gray-100 rounded-2xl flex items-center justify-center shrink-0 overflow-hidden shadow-sm",children:s.vendor_logo?e.jsx("img",{src:s.vendor_logo,className:"w-full h-full object-cover",alt:""}):e.jsx(v,{className:"h-6 w-6 text-gray-400"})}),e.jsxs("div",{className:"flex-1 min-w-0",children:[e.jsxs("div",{className:"flex items-center justify-between mb-1",children:[e.jsx("h4",{className:"text-xs font-black text-gray-900 uppercase truncate tracking-tight",children:s.vendor_name}),s.unread_count&&s.unread_count>0&&e.jsx("span",{className:"w-5 h-5 bg-emerald-600 text-white text-[9px] font-black rounded-full flex items-center justify-center shadow-lg animate-pulse",children:s.unread_count})]}),e.jsx("p",{className:"text-[10px] font-bold text-gray-500 truncate italic opacity-70",children:s.last_message})]})]},s.id))})})]}),e.jsx("div",{className:"flex-1 flex flex-col bg-gray-50/30",children:a?e.jsxs(e.Fragment,{children:[e.jsx("div",{className:"p-6 bg-white border-b border-gray-50 flex items-center justify-between shadow-sm",children:e.jsxs("div",{className:"flex items-center gap-4",children:[e.jsx("div",{className:"w-10 h-10 bg-gray-100 rounded-xl flex items-center justify-center overflow-hidden",children:a.vendor_logo?e.jsx("img",{src:a.vendor_logo,className:"w-full h-full object-cover",alt:""}):e.jsx(v,{className:"h-5 w-5 text-gray-400"})}),e.jsxs("div",{children:[e.jsx("h4",{className:"text-sm font-black text-gray-900 uppercase tracking-tight",children:a.vendor_name}),e.jsxs("p",{className:"text-[8px] font-black text-emerald-600 uppercase tracking-widest flex items-center gap-1.5",children:[e.jsx(I,{className:"w-1.5 h-1.5 fill-current"})," Store Online"]})]})]})}),e.jsxs("div",{className:"flex-1 overflow-y-auto p-8 space-y-4 custom-scrollbar",children:[g.map(s=>e.jsx("div",{className:`flex ${s.sender_id===(t==null?void 0:t.id)?"justify-end":"justify-start"}`,children:e.jsxs("div",{className:`max-w-[70%] p-5 rounded-[1.5rem] text-sm ${s.sender_id===(t==null?void 0:t.id)?"bg-emerald-600 text-white shadow-xl shadow-emerald-200 rounded-tr-none":"bg-white text-gray-700 border border-gray-100 shadow-sm rounded-tl-none"}`,children:[e.jsx("p",{className:"font-bold leading-relaxed",children:s.message}),e.jsx("p",{className:`text-[8px] font-black uppercase tracking-widest mt-2 ${s.sender_id===(t==null?void 0:t.id)?"text-emerald-100":"text-gray-400"}`,children:new Date(s.created_at).toLocaleTimeString([],{hour:"2-digit",minute:"2-digit"})})]})},s.id)),e.jsx("div",{ref:b})]}),e.jsx("div",{className:"p-6 bg-white border-t border-gray-50 shadow-2xl",children:e.jsxs("form",{onSubmit:M,className:"flex items-center gap-4",children:[e.jsx("input",{type:"text",value:c,onChange:s=>u(s.target.value),placeholder:"Ask the vendor about this product...",className:"flex-1 bg-gray-50 border-none rounded-2xl px-6 py-4 text-sm focus:ring-2 focus:ring-emerald-500 outline-none transition-all placeholder:font-bold italic"}),e.jsx("button",{type:"submit",disabled:S||!c.trim(),className:"p-4 bg-emerald-600 text-white rounded-2xl hover:bg-emerald-700 transition shadow-lg shadow-emerald-200 disabled:opacity-50 active:scale-95 group",children:e.jsx(O,{className:"h-5 w-5 transition-transform group-hover:translate-x-1 group-hover:-translate-y-1"})})]})})]}):e.jsxs("div",{className:"flex-1 flex flex-col items-center justify-center p-20 text-center",children:[e.jsx("div",{className:"w-24 h-24 bg-white rounded-[2rem] flex items-center justify-center shadow-2xl shadow-emerald-900/10 mb-8",children:e.jsx(j,{className:"h-12 w-12 text-emerald-600"})}),e.jsx("h3",{className:"text-xl font-black text-gray-900 uppercase tracking-tight mb-2",children:"Concierge Support"}),e.jsx("p",{className:"text-xs text-gray-500 font-bold max-w-sm uppercase tracking-widest leading-loose",children:"Pick a conversation from the sidebar to chat directly with verified vendors. Get instant answers about products, shipping, and more."})]})})]})})]})}export{W as MessagesPage};
